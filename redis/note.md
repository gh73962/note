# Redis
## 数据结构
## 场景
String： 缓存、计数器、分布式锁等。SDS      
List： 链表、队列、微博关注人时间轴列表等。     
Hash： 用户信息、Hash 表等。    
Set： 去重、赞、踩、共同好友等。    
Zset： 访问量排行榜、点击量排行榜等。跳表   

### string
使用simple dynamic string       
结构  len(buf已使用空间长度), free(buf中空闲空间长度)       
空间预分配      
10(已知长度) + 10(预分配长度) + 1(空字符) = 21,若修改后len大于1m,则只会预分配1m     
惰性空间释放        
修改后len变短,不会直接修改len,而是修改free,后续可使用free的空间     
存储数字的话，采用 int 类型的编码，如果是非数字的话，采用 raw 编码      

### ZipList 压缩列表
用于list\hash\sorted list       
连续内存块组成的顺序型结构,ziplist 中可以包含多个 entry 节点，每个节点可以存放整数或者字符串。      

### 双端列表
双端：链表节点带有 prev 和 next 指针，获取某个节点的前置节点和后置节点的复杂度都是 O（1）。     
无环：表头节点的 prev 指针和表尾节点的 next 指针都指向 NULL，对链表的访问以 NULL 为终点。       
带表头指针和表尾指针：通过 list 结构的 head 指针和 tail 指针，程序获取链表的表头节点和表尾节点的复杂度为 O（1）。       
带链表长度计数器：程序使用 list 结构的 len 属性来对 list 持有的链表节点进行计数，程序获取链表中节点数量的复杂度为 O（1）。      
多态：链表节点使用 void* 指针来保存节点值，并且可以通过 list 结构的 dup、free、match 三个属性为节点值设置类型特定函数，所以链表可以用于保存各种不同类型的值。       
quicklist 是 ziplist 和 linkedlist 的混合体，它将 linkedlist 按段切分，每一段使用 ziplist 来紧凑存储，多个 ziplist 之间使用双向指针串接起来。       

#### 跳表
sorted set 类型的排序功能便是通过「跳跃列表」数据结构来实现。       
跳跃表（skiplist）是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。        
跳跃表支持平均 O（logN）、最坏 O（N）复杂度的节点查找，还可以通过顺序性操作来批量处理节点。     
跳表在链表的基础上，增加了多层级索引，通过索引位置的几个跳转，实现数据的快速定位        

### 整数数组（intset）
当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现        



### 单线程与多线程
Redis 的单线程指的是 Redis 的网络 IO 以及键值对指令读写是由一个线程来执行的。       
对于 Redis 的持久化、集群数据同步、异步删除等都是其他线程执行。     

### 单线程的好处
1.不会因为线程创建有额外的开销      
2.没有上下文切换引起的CPU消耗,没有多线程切换的开销      
3.避免线程之间的竞争        

### IO多路复用
多路:多个网络socket的链接 复用:是指复用一个线程     
基本原理是，内核不是监视应用程序本身的连接，而是监视应用程序的文件描述符。      

### redis为什么快:
纯内存操作，一般都是简单的存取操作，线程占用的时间很多，时间的花费主要集中在 IO 上，所以读取速度快。        
整个 Redis 就是一个全局 哈希表，他的时间复杂度是 O(1)，而且为了防止哈希冲突导致链表过长，Redis 会执行 rehash 操作，扩充 哈希桶数量，减少哈希冲突。并且防止一次性 重新映射数据过大导致线程阻塞，采用 渐进式 rehash。巧妙的将一次性拷贝分摊到多次请求过程后总，避免阻塞。         
Redis 使用的是非阻塞 IO：IO 多路复用，使用了单线程来轮询描述符，将数据库的开、关、读、写都转换成了事件，Redis 采用自己实现的事件分离器，效率比较高。        
采用单线程模型，保证了每个操作的原子性，也减少了线程的上下文切换和竞争。        
Redis 全程使用 hash 结构，读取速度快，还有一些特殊的数据结构，对数据存储进行了优化，如压缩表，对短数据进行压缩存储，再如，跳表，使用有序的数据结构加快读取的速度。      
根据实际存储的数据类型选择不同编码      